#!/bin/bash
set -euo pipefail

at() {
    cat <<'EOF'
at HH:MM [DATE] [+ INT PERIOD] <<<CMD
at now + INT PERIOD <<<CMD

DATE := today|tomorrow
    | sun|mon|...
    | jan|feb|... DAY_OF_MONTH
PERIOD := minute|hour|day|week|month|year

A trailing 's' is allowed for PERIODs.

eg:

    at now + 2 hours <<<'cronic touch ~/rah'
    at 23:00 tomorrow <<<'cronic touch ~/rah'
    at 23:00 sep 5 <<<'cronic touch ~/rah'
    at 14:00 + 2 days <<<'cronic sb todo -s check_something'
EOF
}

# bash tab completion.
# Recommended completion spec: complete -C statusbar statusbar sb
bash_tab_completion() {
    # shellcheck disable=SC2034  # unused variable
    local cmd=$1; shift
    local cword=$1; shift
    # shellcheck disable=SC2034  # unused variable
    local prev_word=$1; shift
    compgen -W "$(topics)" "$cword"
}

topics() {
    declare -F | awk '$(NF) !~ /^(bash_tab_completion|topics)$/ {print $(NF)}'
}

if [[ $# -eq 3 && -v COMP_TYPE ]]; then
    bash_tab_completion "$@"
    exit 0
fi

usage="jtex [<options>] <topic>

options:
    -h  show help
    -l  list avaiable topics"

while getopts "hl" opt; do
    case "$opt" in
    h) echo "$usage"; exit 0;;
    l) topics; exit 0;;
    *) exit 1;;
    esac
done

topic=${1:?No topic given}
"$topic"
